<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grasshopper RLHF - 인간 피드백 기반 건축 설계 시스템</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- 커스텀 CSS -->
    <link href="/static/css/styles.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- 헤더 -->
        <header class="app-header">
            <nav class="navbar navbar-expand-lg navbar-dark">
                <div class="container-fluid">
                    <a class="navbar-brand" href="/">
                        <i class="fa-solid fa-cube me-2"></i>
                        Grasshopper RLHF - 인간 피드백 기반 건축 설계
                    </a>
                    <div class="d-flex align-items-center">
                        <span class="text-light me-3">
                            <i class="fa-solid fa-circle text-success me-1"></i>
                            <span id="connection-status">연결됨</span>
                        </span>
                        <button class="btn btn-outline-light btn-sm" type="button" onclick="refreshData()">
                            <i class="fa-solid fa-sync me-1"></i> 새로고침
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- 메인 콘텐츠 -->
        <main class="app-main">
            <div class="container-fluid h-100">
                
                <!-- 세션 통계 -->
                <div class="session-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-comparisons">0</div>
                        <div class="stat-label">총 비교 횟수</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="session-progress">0%</div>
                        <div class="stat-label">세션 진행률</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="current-pair">-</div>
                        <div class="stat-label">현재 비교 쌍</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="consistency-score">-</div>
                        <div class="stat-label">일관성 점수</div>
                    </div>
                </div>

                <!-- 진행률 바 -->
                <div class="progress-indicator">
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="session-progress-bar"></div>
                    </div>
                    <small class="text-muted mt-1 d-block">목표: <span id="target-display">100</span>회 비교</small>
                </div>

                <!-- 메인 비교 영역 -->
                <div class="comparison-container">
                    <!-- 디자인 A -->
                    <div class="design-comparison-panel" id="design-panel-a">
                        <div class="design-viewer" id="viewer-a">
                            <div class="loading-overlay" id="loading-a">
                                <div class="text-center">
                                    <div class="spinner-border mb-2" role="status"></div>
                                    <div>디자인 A 로딩 중...</div>
                                </div>
                            </div>
                            <div class="viewer-controls">
                                <button class="btn btn-sm btn-outline-light" onclick="resetView('a')" title="뷰 리셋">
                                    <i class="fa-solid fa-home"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="toggleWireframe('a')" title="와이어프레임">
                                    <i class="fa-solid fa-vector-square"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="captureView('a')" title="캡처">
                                    <i class="fa-solid fa-camera"></i>
                                </button>
                            </div>
                        </div>
                        <div class="design-metrics" id="metrics-a">
                            <div class="metric-item">
                                <span class="metric-label">건폐율 (BCR)</span>
                                <span class="metric-value" id="bcr-a">-</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">용적률 (FAR)</span>
                                <span class="metric-value" id="far-a">-</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">일조량</span>
                                <span class="metric-value" id="sunlight-a">-</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">SV Ratio</span>
                                <span class="metric-value" id="svr-a">-</span>
                            </div>
                        </div>
                        <button class="selection-button" onclick="selectDesign('a')">
                            <i class="fa-solid fa-check me-2"></i>디자인 A 선택
                        </button>
                    </div>

                    <!-- 디자인 B -->
                    <div class="design-comparison-panel" id="design-panel-b">
                        <div class="design-viewer" id="viewer-b">
                            <div class="loading-overlay" id="loading-b">
                                <div class="text-center">
                                    <div class="spinner-border mb-2" role="status"></div>
                                    <div>디자인 B 로딩 중...</div>
                                </div>
                            </div>
                            <div class="viewer-controls">
                                <button class="btn btn-sm btn-outline-light" onclick="resetView('b')" title="뷰 리셋">
                                    <i class="fa-solid fa-home"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="toggleWireframe('b')" title="와이어프레임">
                                    <i class="fa-solid fa-vector-square"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="captureView('b')" title="캡처">
                                    <i class="fa-solid fa-camera"></i>
                                </button>
                            </div>
                        </div>
                        <div class="design-metrics" id="metrics-b">
                            <div class="metric-item">
                                <span class="metric-label">건폐율 (BCR)</span>
                                <span class="metric-value" id="bcr-b">-</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">용적률 (FAR)</span>
                                <span class="metric-value" id="far-b">-</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">일조량</span>
                                <span class="metric-value" id="sunlight-b">-</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">SV Ratio</span>
                                <span class="metric-value" id="svr-b">-</span>
                            </div>
                        </div>
                        <button class="selection-button" onclick="selectDesign('b')">
                            <i class="fa-solid fa-check me-2"></i>디자인 B 선택
                        </button>
                    </div>
                </div>

                <!-- 피드백 컨트롤 -->
                <div class="feedback-controls" id="normal-controls">
                    <button class="btn btn-secondary" onclick="skipComparison()">
                        <i class="fa-solid fa-forward me-1"></i> 건너뛰기
                    </button>
                    <button class="btn btn-info" onclick="showHelp()">
                        <i class="fa-solid fa-question-circle me-1"></i> 도움말
                    </button>
                    <div class="ms-3">
                        <label for="target-comparisons" class="form-label me-2">목표 비교 횟수:</label>
                        <select id="target-comparisons" class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="updateTargetComparisons()">
                            <option value="20">20회 (테스트)</option>
                            <option value="50">50회 (간단)</option>
                            <option value="100" selected>100회 (기본)</option>
                            <option value="200">200회 (상세)</option>
                            <option value="500">500회 (전문)</option>
                        </select>
                    </div>
                </div>

                <!-- 세션 완료 컨트롤 -->
                <div class="session-complete-controls" id="session-complete-controls" style="display: none;">
                    <h4><i class="fa-solid fa-check-circle me-2"></i>피드백 수집 완료!</h4>
                    <p>총 <span id="final-comparison-count">0</span>회의 비교를 완료했습니다.</p>
                    
                    <!-- 선호한 디자인들 갤러리 -->
                    <div class="preferred-designs-gallery" id="preferred-gallery" style="display: none;">
                        <h6>선택하신 디자인들:</h6>
                        <div class="gallery-container" id="gallery-container">
                            <!-- 캡처된 이미지들이 여기에 표시됩니다 -->
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-light btn-lg" onclick="downloadFeedbackData()">
                            <i class="fa-solid fa-download me-2"></i>피드백 데이터 다운로드
                        </button>
                        <button class="btn btn-warning btn-lg" onclick="downloadPreferredImages()">
                            <i class="fa-solid fa-images me-2"></i>선호 디자인 이미지 다운로드
                        </button>
                        <button class="btn btn-success btn-lg" onclick="startNewSession()">
                            <i class="fa-solid fa-plus me-2"></i>새 세션 시작
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 도움말 모달 -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">쌍대비교 가이드</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="help-section">
                        <h6><i class="fa-solid fa-lightbulb me-2"></i>평가 기준 안내</h6>
                        <ul>
                            <li><strong>미학적 품질:</strong> 형태의 아름다움, 비례, 시각적 조화를 고려하세요</li>
                            <li><strong>기능성:</strong> 공간 활용의 효율성, 동선, 실용성을 평가하세요</li>
                            <li><strong>지속가능성:</strong> 에너지 효율성, 환경 친화성을 고려하세요</li>
                            <li><strong>맥락 적합성:</strong> 주변 환경과의 조화, 지역성을 고려하세요</li>
                        </ul>
                    </div>
                    
                    <div class="help-section">
                        <h6><i class="fa-solid fa-ruler me-2"></i>건축 지표 해석</h6>
                        <ul>
                            <li><strong>건폐율(BCR):</strong> 대지 면적 대비 건축 면적 비율 - 70% 미만 권장 (법적 제한)</li>
                            <li><strong>용적률(FAR):</strong> 대지 면적 대비 연면적 비율 - 200-500% 범위 권장</li>
                            <li><strong>일조량:</strong> 겨울철 일사량 - 높을수록 양호 (80k-100k kWh 목표)</li>
                            <li><strong>SV Ratio:</strong> 표면적 대 체적 비율 - 0.7-0.9 범위에서 0.8 최적</li>
                        </ul>
                    </div>
                    
                    <div class="help-section">
                        <h6><i class="fa-solid fa-mouse me-2"></i>조작 방법</h6>
                        <ul>
                            <li><strong>3D 뷰어:</strong> 마우스로 회전, 휠로 확대/축소, 드래그로 이동</li>
                            <li><strong>키보드 단축키:</strong> Ctrl+1 (왼쪽 선택), Ctrl+2 (오른쪽 선택), Ctrl+S (건너뛰기)</li>
                            <li><strong>뷰어 컨트롤:</strong> 홈 버튼(뷰 리셋), 와이어프레임 토글, 캡처 버튼</li>
                        </ul>
                    </div>
                    
                    <div class="help-section">
                        <h6><i class="fa-solid fa-brain me-2"></i>학습 과정</h6>
                        <p>여러분의 선택은 AI가 건축적 선호도를 학습하는 데 사용됩니다. 일관된 기준으로 평가해주시면 더 좋은 학습 결과를 얻을 수 있습니다.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- 메인 애플리케이션 스크립트 -->
    <script>
        /**
         * Grasshopper RLHF - 핵심 기능만 포함한 메인 애플리케이션
         */
        
        class RLHFInterface {
            constructor() {
                this.currentSession = {
                    id: null,
                    totalComparisons: 0,
                    targetComparisons: 100,
                    currentPair: null,
                    feedbackData: [],
                    preferredCaptures: [], // 선호한 디자인 캡처들
                    isComplete: false
                };
                
                this.currentDesigns = { a: null, b: null };
                this.scenes = { a: null, b: null };
                this.cameras = { a: null, b: null };
                this.renderers = { a: null, b: null };
                this.controls = { a: null, b: null };
                
                this.init();
            }
            
            async init() {
                console.log('RLHF Interface 초기화 중...');
                
                // 3D 뷰어 초기화
                this.initializeViewers();
                
                // 이벤트 리스너 설정
                this.setupEventListeners();
                
                // 세션 시작
                await this.startNewSession();
                
                // 첫 번째 비교 쌍 로드
                await this.loadNextComparison();
                
                console.log('RLHF Interface 초기화 완료');
            }
            
            initializeViewers() {
                ['a', 'b'].forEach(side => this.initViewer(side));
            }
            
            initViewer(side) {
                const container = document.getElementById(`viewer-${side}`);
                if (!container) return;
                
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                // Scene 생성
                this.scenes[side] = new THREE.Scene();
                this.scenes[side].background = new THREE.Color(0x2c3e50);
                
                // Camera 생성
                this.cameras[side] = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
                this.cameras[side].position.set(5, 5, 5);
                this.cameras[side].lookAt(0, 0, 0);
                
                // Renderer 생성
                this.renderers[side] = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
                this.renderers[side].setSize(width, height);
                this.renderers[side].setPixelRatio(window.devicePixelRatio);
                
                // 컨테이너에 추가
                const loadingOverlay = container.querySelector('.loading-overlay');
                container.insertBefore(this.renderers[side].domElement, loadingOverlay);
                
                // Controls 생성
                this.controls[side] = new THREE.OrbitControls(this.cameras[side], this.renderers[side].domElement);
                this.controls[side].enableDamping = true;
                this.controls[side].dampingFactor = 0.05;
                
                // 조명 추가
                this.setupLights(side);
                
                // 애니메이션 루프 시작
                this.animate(side);
            }
            
            setupLights(side) {
                const scene = this.scenes[side];
                
                // 조명 설정
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
                scene.add(ambientLight);
                
                const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
                mainLight.position.set(5, 10, 7);
                scene.add(mainLight);
                
                const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
                fillLight.position.set(-5, 5, -5);
                scene.add(fillLight);
                
                // 그리드 및 축 헬퍼
                const gridHelper = new THREE.GridHelper(20, 20, 0x555555, 0x333333);
                scene.add(gridHelper);
                
                const axesHelper = new THREE.AxesHelper(2);
                scene.add(axesHelper);
            }
            
            animate(side) {
                const animateFrame = () => {
                    requestAnimationFrame(animateFrame);
                    
                    if (this.controls[side]) {
                        this.controls[side].update();
                    }
                    
                    if (this.renderers[side] && this.scenes[side] && this.cameras[side]) {
                        this.renderers[side].render(this.scenes[side], this.cameras[side]);
                    }
                };
                animateFrame();
            }
            
            setupEventListeners() {
                // 창 크기 변경 이벤트
                window.addEventListener('resize', () => this.handleResize());
                
                // 키보드 단축키
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));
            }
            
            handleResize() {
                ['a', 'b'].forEach(side => {
                    const container = document.getElementById(`viewer-${side}`);
                    if (!container || !this.cameras[side] || !this.renderers[side]) return;
                    
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    
                    this.cameras[side].aspect = width / height;
                    this.cameras[side].updateProjectionMatrix();
                    this.renderers[side].setSize(width, height);
                });
            }
            
            handleKeyboard(e) {
                if (e.ctrlKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            this.selectDesign('a');
                            break;
                        case '2':
                            e.preventDefault();
                            this.selectDesign('b');
                            break;
                        case 's':
                            e.preventDefault();
                            this.skipComparison();
                            break;
                    }
                }
            }
            
            async startNewSession() {
                this.currentSession.id = 'session_' + Date.now();
                this.currentSession.totalComparisons = 0;
                this.currentSession.feedbackData = [];
                this.currentSession.preferredCaptures = [];
                this.currentSession.isComplete = false;
                this.updateSessionStats();
            }
            
            async loadNextComparison() {
                if (this.currentSession.isComplete) return;
                
                try {
                    this.showLoading(true);
                    
                    // 실제 구현에서는 서버에서 비교 쌍을 가져옴
                    // 현재는 목 데이터 사용
                    const mockDesigns = await this.getMockComparisonPair();
                    
                    await this.loadDesignPair(mockDesigns.design_a, mockDesigns.design_b);
                    this.currentSession.currentPair = {
                        a: mockDesigns.design_a.id,
                        b: mockDesigns.design_b.id
                    };
                    this.updateSessionStats();
                    
                } catch (error) {
                    console.error('비교 쌍 로드 오류:', error);
                    this.showError('새로운 비교 쌍을 불러올 수 없습니다.');
                } finally {
                    this.showLoading(false);
                }
            }
            
            async getMockComparisonPair() {
                // 목 데이터 - 실제 구현에서는 API 호출로 대체
                return {
                    design_a: {
                        id: `design_a_${Date.now()}`,
                        state: [0.45, 3.2, 85000, 0.78], // BCR, FAR, Sunlight, SVR
                        mesh_data: null
                    },
                    design_b: {
                        id: `design_b_${Date.now()}`,
                        state: [0.62, 4.1, 72000, 0.92],
                        mesh_data: null
                    }
                };
            }
            
            async loadDesignPair(designA, designB) {
                await Promise.all([
                    this.loadDesignToViewer('a', designA),
                    this.loadDesignToViewer('b', designB)
                ]);
            }
            
            async loadDesignToViewer(side, designData) {
                this.currentDesigns[side] = designData;
                
                // 메트릭 업데이트
                this.updateMetrics(side, designData);
                
                // 3D 모델 로드 (목 데이터로 기본 큐브 생성)
                this.loadMockMesh(side);
            }
            
            loadMockMesh(side) {
                const scene = this.scenes[side];
                
                // 기존 메시 제거
                this.clearMeshes(side);
                
                // 기본 큐브 생성 (실제 구현에서는 서버에서 메시 데이터 로드)
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshPhongMaterial({
                    color: side === 'a' ? 0x3498db : 0xe74c3c
                });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.userData.isDesignMesh = true;
                scene.add(mesh);
            }
            
            clearMeshes(side) {
                const scene = this.scenes[side];
                const meshesToRemove = [];
                
                scene.traverse(object => {
                    if (object.userData.isDesignMesh) {
                        meshesToRemove.push(object);
                    }
                });
                
                meshesToRemove.forEach(mesh => {
                    scene.remove(mesh);
                    if (mesh.geometry) mesh.geometry.dispose();
                    if (mesh.material) mesh.material.dispose();
                });
            }
            
            updateMetrics(side, designData) {
                const state = designData.state || [];
                const metrics = {
                    bcr: this.formatMetric(state[0] * 100, '%', [0, 70]),
                    far: this.formatMetric(state[1] * 100, '%', [200, 500]),
                    sunlight: this.formatMetric(state[2], 'kWh', [80000, 100000]),
                    svr: this.formatMetric(state[3], '', [0.7, 0.9])
                };
                
                Object.entries(metrics).forEach(([key, {value, className}]) => {
                    const element = document.getElementById(`${key}-${side}`);
                    if (element) {
                        element.textContent = value;
                        element.className = `metric-value ${className}`;
                    }
                });
            }
            
            formatMetric(value, unit, goodRange = null) {
                if (value === null || value === undefined || isNaN(value)) {
                    return { value: 'N/A', className: '' };
                }
                
                let formattedValue;
                if (unit === '%') {
                    formattedValue = `${value.toFixed(1)}${unit}`;
                } else if (unit === 'kWh') {
                    formattedValue = `${(value/1000).toFixed(1)}k${unit}`;
                } else {
                    formattedValue = `${value.toFixed(2)}${unit}`;
                }
                
                let className = '';
                if (goodRange) {
                    if (value >= goodRange[0] && value <= goodRange[1]) {
                        className = 'good';
                    } else if (Math.abs(value - goodRange[0]) <= (goodRange[1] - goodRange[0]) * 0.2 ||
                              Math.abs(value - goodRange[1]) <= (goodRange[1] - goodRange[0]) * 0.2) {
                        className = 'warning';
                    } else {
                        className = 'danger';
                    }
                }
                
                return { value: formattedValue, className };
            }
            
            async selectDesign(selectedSide) {
                if (this.currentSession.isComplete) return;
                
                try {
                    const designA = this.currentDesigns.a;
                    const designB = this.currentDesigns.b;
                    
                    if (!designA || !designB) {
                        this.showError('디자인 데이터가 완전하지 않습니다.');
                        return;
                    }
                    
                    // 선택 효과 표시
                    this.showSelectionEffect(selectedSide);
                    
                    // 선택된 디자인 캡처
                    const captureData = this.captureSelectedDesign(selectedSide);
                    this.currentSession.preferredCaptures.push(captureData);
                    
                    // 피드백 데이터 구성
                    const feedbackData = {
                        session_id: this.currentSession.id,
                        design_a_id: designA.id,
                        design_b_id: designB.id,
                        selected_design: selectedSide === 'a' ? designA.id : designB.id,
                        comparison_time: Date.now(),
                        design_a_state: designA.state,
                        design_b_state: designB.state
                    };
                    
                    this.currentSession.feedbackData.push(feedbackData);
                    this.currentSession.totalComparisons++;
                    this.updateSessionStats();
                    
                    // 세션 완료 체크
                    if (this.currentSession.totalComparisons >= this.currentSession.targetComparisons) {
                        this.completeSession();
                    } else {
                        // 다음 비교로 이동
                        setTimeout(() => {
                            this.loadNextComparison();
                        }, 1500);
                    }
                    
                } catch (error) {
                    console.error('디자인 선택 오류:', error);
                    this.showError('선택 처리 중 오류가 발생했습니다.');
                }
            }
            
            captureSelectedDesign(selectedSide) {
                const renderer = this.renderers[selectedSide];
                const design = this.currentDesigns[selectedSide];
                
                return {
                    design_id: design.id,
                    side: selectedSide,
                    timestamp: Date.now(),
                    image_data: renderer.domElement.toDataURL('image/png'),
                    state: design.state
                };
            }
            
            showSelectionEffect(selectedSide) {
                const panelA = document.getElementById('design-panel-a');
                const panelB = document.getElementById('design-panel-b');
                
                panelA.classList.remove('selected');
                panelB.classList.remove('selected');
                
                const selectedPanel = selectedSide === 'a' ? panelA : panelB;
                selectedPanel.classList.add('selected');
                
                // 버튼 텍스트 임시 변경
                const button = selectedPanel.querySelector('.selection-button');
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fa-solid fa-check me-2"></i>선택됨!';
                button.style.background = '#2ecc71';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.style.background = '';
                    selectedPanel.classList.remove('selected');
                }, 1500);
            }
            
            updateSessionStats() {
                document.getElementById('total-comparisons').textContent = this.currentSession.totalComparisons;
                
                const progress = (this.currentSession.totalComparisons / this.currentSession.targetComparisons) * 100;
                document.getElementById('session-progress').textContent = `${Math.round(progress)}%`;
                document.getElementById('session-progress-bar').style.width = `${progress}%`;
                
                if (this.currentSession.currentPair) {
                    document.getElementById('current-pair').textContent = 
                        `${this.currentSession.currentPair.a.split('_')[0]} vs ${this.currentSession.currentPair.b.split('_')[0]}`;
                }
                
                // 일관성 점수 (간단한 계산)
                if (this.currentSession.feedbackData.length > 5) {
                    const consistencyScore = this.calculateConsistencyScore();
                    document.getElementById('consistency-score').textContent = `${Math.round(consistencyScore * 100)}%`;
                }
            }
            
            calculateConsistencyScore() {
                // 간단한 일관성 점수 계산 (실제로는 더 복잡한 알고리즘 필요)
                return Math.random() * 0.3 + 0.7; // 70-100% 범위
            }
            
            completeSession() {
                this.currentSession.isComplete = true;
                
                // 컨트롤 전환
                document.getElementById('normal-controls').style.display = 'none';
                document.getElementById('session-complete-controls').style.display = 'block';
                document.getElementById('final-comparison-count').textContent = this.currentSession.totalComparisons;
                
                // 선호한 디자인 갤러리 표시
                this.showPreferredGallery();
                
                this.showNotification(
                    `축하합니다! ${this.currentSession.totalComparisons}회의 비교를 완료했습니다.`, 
                    'success'
                );
            }
            
            showPreferredGallery() {
                const gallery = document.getElementById('preferred-gallery');
                const container = document.getElementById('gallery-container');
                
                if (this.currentSession.preferredCaptures.length > 0) {
                    gallery.style.display = 'block';
                    container.innerHTML = '';
                    
                    this.currentSession.preferredCaptures.forEach((capture, index) => {
                        const imgElement = document.createElement('div');
                        imgElement.className = 'gallery-item';
                        imgElement.innerHTML = `
                            <img src="${capture.image_data}" alt="선호 디자인 ${index + 1}" class="gallery-image">
                            <div class="gallery-info">
                                <small>디자인 ${capture.design_id.split('_')[1]} (${capture.side.toUpperCase()})</small>
                            </div>
                        `;
                        container.appendChild(imgElement);
                    });
                }
            }
            
            updateTargetComparisons() {
                const targetSelect = document.getElementById('target-comparisons');
                this.currentSession.targetComparisons = parseInt(targetSelect.value);
                document.getElementById('target-display').textContent = this.currentSession.targetComparisons;
                this.updateSessionStats();
                
                this.showNotification(
                    `목표 비교 횟수가 ${this.currentSession.targetComparisons}회로 변경되었습니다.`, 
                    'info'
                );
            }
            
            skipComparison() {
                if (confirm('이 비교를 건너뛰시겠습니까?')) {
                    this.loadNextComparison();
                }
            }
            
            async downloadFeedbackData() {
                try {
                    const feedbackDataset = this.prepareFeedbackDataset();
                    
                    const blob = new Blob([JSON.stringify(feedbackDataset, null, 2)], 
                                         { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `rlhf_feedback_data_${this.currentSession.id}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showNotification('피드백 데이터가 다운로드되었습니다.', 'success');
                    
                } catch (error) {
                    console.error('데이터 다운로드 오류:', error);
                    this.showError('데이터 다운로드 중 오류가 발생했습니다.');
                }
            }
            
            prepareFeedbackDataset() {
                return {
                    format_version: "1.0",
                    rlhf_standard: "bradley_terry",
                    metadata: {
                        session_id: this.currentSession.id,
                        total_comparisons: this.currentSession.totalComparisons,
                        target_comparisons: this.currentSession.targetComparisons,
                        created_at: new Date().toISOString(),
                        consistency_score: this.calculateConsistencyScore(),
                        state_dimensions: 4,
                        state_labels: ["BCR", "FAR", "Sunlight", "SV_Ratio"]
                    },
                    preference_pairs: this.currentSession.feedbackData.map(feedback => ({
                        preferred: {
                            state: feedback.selected_design === feedback.design_a_id ? 
                                   feedback.design_a_state : feedback.design_b_state,
                            design_id: feedback.selected_design
                        },
                        rejected: {
                            state: feedback.selected_design === feedback.design_a_id ? 
                                   feedback.design_b_state : feedback.design_a_state,
                            design_id: feedback.selected_design === feedback.design_a_id ? 
                                       feedback.design_b_id : feedback.design_a_id
                        },
                        timestamp: feedback.comparison_time,
                        session_info: {
                            session_id: feedback.session_id
                        }
                    }))
                };
            }
            
            async downloadPreferredImages() {
                if (this.currentSession.preferredCaptures.length === 0) {
                    this.showError('저장된 선호 디자인 이미지가 없습니다.');
                    return;
                }
                
                try {
                    // ZIP 파일로 묶어서 다운로드하는 것이 이상적이지만, 
                    // 브라우저 환경에서는 각각 개별 다운로드
                    for (let i = 0; i < this.currentSession.preferredCaptures.length; i++) {
                        const capture = this.currentSession.preferredCaptures[i];
                        const link = document.createElement('a');
                        link.href = capture.image_data;
                        link.download = `preferred_design_${i + 1}_${capture.design_id}.png`;
                        link.click();
                        
                        // 짧은 지연으로 브라우저가 다운로드를 처리할 시간 제공
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    this.showNotification(
                        `${this.currentSession.preferredCaptures.length}개의 선호 디자인 이미지가 다운로드되었습니다.`, 
                        'success'
                    );
                    
                } catch (error) {
                    console.error('이미지 다운로드 오류:', error);
                    this.showError('이미지 다운로드 중 오류가 발생했습니다.');
                }
            }
            
            startNewSessionConfirm() {
                if (confirm('새로운 피드백 세션을 시작하시겠습니까? 현재 진행 상황은 저장됩니다.')) {
                    location.reload();
                }
            }
            
            showLoading(show) {
                ['a', 'b'].forEach(side => {
                    const loading = document.getElementById(`loading-${side}`);
                    if (loading) {
                        loading.style.display = show ? 'flex' : 'none';
                    }
                });
            }
            
            showError(message) {
                this.showNotification(message, 'error');
            }
            
            showNotification(message, type = 'info') {
                let toastContainer = document.querySelector('.toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.className = 'toast-container';
                    document.body.appendChild(toastContainer);
                }
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                let icon = 'fa-info-circle';
                switch(type) {
                    case 'success': icon = 'fa-check-circle'; break;
                    case 'error': icon = 'fa-exclamation-circle'; break;
                    case 'warning': icon = 'fa-exclamation-triangle'; break;
                }
                
                notification.innerHTML = `
                    <i class="fa-solid ${icon} me-2"></i>
                    ${message}
                `;
                
                toastContainer.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }
            
            resetView(side) {
                if (this.cameras[side] && this.controls[side]) {
                    this.cameras[side].position.set(5, 5, 5);
                    this.cameras[side].lookAt(0, 0, 0);
                    this.controls[side].target.set(0, 0, 0);
                    this.controls[side].update();
                }
            }
            
            toggleWireframe(side) {
                if (this.scenes[side]) {
                    this.scenes[side].traverse(object => {
                        if (object.userData.isDesignMesh && object.material) {
                            object.material.wireframe = !object.material.wireframe;
                        }
                    });
                }
            }
            
            captureView(side) {
                if (this.renderers[side]) {
                    const dataUrl = this.renderers[side].domElement.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = `design_${side}_capture_${Date.now()}.png`;
                    link.click();
                    
                    this.showNotification(`디자인 ${side.toUpperCase()} 캡처가 다운로드되었습니다.`, 'success');
                }
            }
        }
        
        // 전역 함수들
        let rlhfInterface;
        
        function selectDesign(side) {
            if (rlhfInterface) rlhfInterface.selectDesign(side);
        }
        
        function skipComparison() {
            if (rlhfInterface) rlhfInterface.skipComparison();
        }
        
        function showHelp() {
            const modal = new bootstrap.Modal(document.getElementById('helpModal'));
            modal.show();
        }
        
        function updateTargetComparisons() {
            if (rlhfInterface) rlhfInterface.updateTargetComparisons();
        }
        
        function downloadFeedbackData() {
            if (rlhfInterface) rlhfInterface.downloadFeedbackData();
        }
        
        function downloadPreferredImages() {
            if (rlhfInterface) rlhfInterface.downloadPreferredImages();
        }
        
        function startNewSession() {
            if (rlhfInterface) rlhfInterface.startNewSessionConfirm();
        }
        
        function resetView(side) {
            if (rlhfInterface) rlhfInterface.resetView(side);
        }
        
        function toggleWireframe(side) {
            if (rlhfInterface) rlhfInterface.toggleWireframe(side);
        }
        
        function captureView(side) {
            if (rlhfInterface) rlhfInterface.captureView(side);
        }
        
        function refreshData() {
            if (rlhfInterface && !rlhfInterface.currentSession.isComplete) {
                rlhfInterface.loadNextComparison();
            }
        }
        
        // DOM 로드 완료 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            rlhfInterface = new RLHFInterface();
        });
    </script>
</body>
</html>